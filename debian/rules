#!/usr/bin/make -f
#
export DH_VERBOSE=1
export DEB_BUILD_HARDENING=1
export NJOBS=$(shell grep -c processor /proc/cpuinfo)
export PSM_TARGETS=mongod mongos mongo
export PSMSRC=$(shell pwd)
export MONGOTOOLS=bsondump mongostat mongofiles mongoexport mongoimport mongorestore mongodump mongotop mongooplog
#
clean:
	rm -fr $(PSMSRC)/bin
	rm -fr $(PSMSRC)/src/third_party/PerconaFT/pft-build
	rm -fr $(PSMSRC)/src/third_party/pft
	scons -c --variant-dir=percona --release --ssl --opt -j$(NJOBS) --use-sasl-client CPPPATH=$(PSMSRC)/src/third_party/pft/include \
	LIBPATH=$(PSMSRC)/src/third_party/pft/lib --PerconaFT --rocksdb --wiredtiger --allocator=jemalloc $(PSM_TARGETS)
	rm -fr build
	find $(PSMSRC) -name '*.pyc' -delete
		
PerconaFT-configure: 
	mkdir -p $(PSMSRC)/src/third_party/PerconaFT/pft-build
	cd $(PSMSRC)/src/third_party/PerconaFT/pft-build
	cmake -DCMAKE_BUILD_TYPE=Release -DUSE_VALGRIND=OFF \
	-DTOKU_DEBUG_PARANOID=OFF -DBUILD_TESTING=OFF \
	-DCMAKE_INSTALL_PREFIX=$(PSMSRC)/src/third_party/PerconaFT/pft-build/install $(PSMSRC)/src/third_party/PerconaFT

PerconaFT: PerconaFT-configure
	cd $(PSMSRC)/src/third_party/PerconaFT/pft-build
	make -j$(NJOBS) install 
	mv $(PSMSRC)/src/third_party/PerconaFT/pft-build/install $(PSMSRC)/src/third_party/pft
	rm -rfv $(PSMSRC)/src/third_party/PerconaFT/pft-build
	
percona-server-mongodb: PerconaFT
	scons --variant-dir=percona --release --ssl --opt=on -j$(NJOBS) --use-sasl-client CPPPATH=$(PSMSRC)/src/third_party/pft/include \
	LIBPATH=$(PSMSRC)/src/third_party/pft/lib --PerconaFT --rocksdb --wiredtiger --allocator=jemalloc $(PSM_TARGETS)

compile-mongo-tools:
	rm -rf $(PSMSRC)/mongo-tools/vendor/pkg
	mkdir -p $(PSMSRC)/bin
	for tool in $(MONGOTOOLS) ; do \
		go build -a -x -o $(PSMSRC)/bin/$$tool $(PSMSRC)/mongo-tools/$$tool/main/$$tool.go ; \
	done

build: compile-mongo-tools percona-server-mongodb
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs
	cp -av mongos debian/percona-server-mongodb-mongos/usr/bin
	cp -av mongo debian/percona-server-mongodb-shell/usr/bin
	cp -av mongod debian/percona-server-mongodb-server/usr/sbin
	cp -av debian/percona-server-mongodb-helper.sh debian/percona-server-mongodb-server/usr/bin
	cp -av debian/mongod.conf debian/percona-server-mongodb-server/etc/mongod.conf
	cp -av $(PSMSRC)/bin/* debian/percona-server-mongodb-tools/usr/bin
	dh_systemd_enable --name=mongod
	dh_installinit -a --name=mongod
	dh_installman -a
	dh_installdocs -a

binary: 
	dh_systemd_start
	dh_strip -a --dbg-package=percona-server-mongodb-dbg
	dh_lintian
	dh_fixperms -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

